#!/usr/bin/env node
"use strict";const n=require("fs-extra"),e=require("path"),t=require("chalk"),o=require("axios");module.exports=class{constructor(n={}){this.options={models:[{name:"bigscience/bloom-560m",apiKey:process.env.HUGGING_FACE_API_KEY,endpoint:"https://api-inference.huggingface.co/models",type:"huggingface"},{name:"qwen-7b-chat",apiKey:process.env.DASHSCOPE_API_KEY,endpoint:"https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",type:"dashscope"},{name:"gpt-3.5-turbo",apiKey:process.env.OPENAI_API_KEY,endpoint:"https://api.openai.com/v1/chat/completions",type:"openai"}].filter((n=>n.apiKey)),temperature:.7,maxTokens:2e3,...n}}async reviewFile(a,r){try{const t=n.readFileSync(a,"utf8"),i=e.relative(process.cwd(),a),s=`请对以下代码进行审核，重点关注：\n1. 代码质量和可读性\n2. 潜在的性能问题\n3. 安全隐患\n4. 最佳实践\n5. 可能的改进建议\n\n文件路径：${i}\n代码内容：\n\`\`\`\n${t}\n\`\`\`\n\n请用中文回复，并按照以下格式输出：\n# 代码审核报告\n\n## 文件信息\n- 文件路径：${i}\n- 审核时间：${(new Date).toLocaleString()}\n- 使用模型：${r.name}\n\n## 审核结果\n[在这里详细说明审核结果]\n\n## 改进建议\n[在这里列出具体的改进建议]\n\n## 总结\n[在这里总结主要发现和建议]`;let p;switch(r.type){case"huggingface":return p=await o.post(`${r.endpoint}/${r.name}`,{inputs:s,parameters:{max_length:this.options.maxTokens,temperature:this.options.temperature,return_full_text:!1}},{headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"}}),p.data[0].generated_text;case"dashscope":return p=await o.post(r.endpoint,{model:r.name,input:{messages:[{role:"user",content:s}]},parameters:{temperature:this.options.temperature,max_tokens:this.options.maxTokens}},{headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"}}),p.data.output.text;case"openai":return p=await o.post(r.endpoint,{model:r.name,messages:[{role:"user",content:s}],temperature:this.options.temperature,max_tokens:this.options.maxTokens},{headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"}}),p.data.choices[0].message.content;default:throw new Error(`不支持的模型类型：${r.type}`)}}catch(n){return console.error(t.red(`使用模型 ${r.name} 审核文件 ${a} 时出错：${n.message}`)),null}}async reviewDirectory(o){const a=[],r={},i=t=>{n.readdirSync(t).forEach((o=>{const r=e.join(t,o);n.statSync(r).isDirectory()?i(r):this.shouldReviewFile(o)&&a.push(r)}))};i(o),this.options.models.forEach((n=>{r[n.name]=[]}));for(const n of a){console.log(t.blue(`正在审核文件：${n}`));for(const e of this.options.models){console.log(t.blue(`使用模型 ${e.name} 进行审核...`));const o=await this.reviewFile(n,e);o&&r[e.name].push(o)}}return r}shouldReviewFile(n){return[".js",".jsx",".ts",".tsx",".vue",".py",".java",".cpp",".c",".cs"].some((e=>n.endsWith(e)))}generateHtmlReport(t){const o=`\n<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>多模型代码审核对比报告</title>\n    <style>\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            max-width: 1200px;\n            margin: 0 auto;\n            padding: 20px;\n        }\n        h1 {\n            color: #2c3e50;\n            border-bottom: 2px solid #eee;\n            padding-bottom: 10px;\n        }\n        h2 {\n            color: #34495e;\n            margin-top: 30px;\n        }\n        .model-section {\n            margin-bottom: 40px;\n            padding: 20px;\n            border: 1px solid #eee;\n            border-radius: 8px;\n        }\n        .model-header {\n            background-color: #f8f9fa;\n            padding: 10px;\n            border-radius: 5px;\n            margin-bottom: 20px;\n        }\n        pre {\n            background-color: #f8f9fa;\n            padding: 15px;\n            border-radius: 5px;\n            overflow-x: auto;\n        }\n        code {\n            font-family: 'Courier New', Courier, monospace;\n            background-color: #f8f9fa;\n            padding: 2px 5px;\n            border-radius: 3px;\n        }\n        .file-info {\n            background-color: #f8f9fa;\n            padding: 10px;\n            border-radius: 5px;\n            margin: 10px 0;\n        }\n        .timestamp {\n            color: #666;\n            font-size: 0.9em;\n        }\n        .model-comparison {\n            margin-top: 40px;\n            padding: 20px;\n            background-color: #f8f9fa;\n            border-radius: 8px;\n        }\n        .model-comparison h2 {\n            color: #2c3e50;\n            margin-bottom: 20px;\n        }\n        .comparison-table {\n            width: 100%;\n            border-collapse: collapse;\n            margin-top: 20px;\n        }\n        .comparison-table th,\n        .comparison-table td {\n            padding: 10px;\n            border: 1px solid #ddd;\n            text-align: left;\n        }\n        .comparison-table th {\n            background-color: #f1f1f1;\n        }\n    </style>\n</head>\n<body>\n    <h1>多模型代码审核对比报告</h1>\n    <div class="timestamp">生成时间：${(new Date).toLocaleString()}</div>\n    \n    ${Object.entries(t).map((([n,e])=>`\n        <div class="model-section">\n            <div class="model-header">\n                <h2>模型：${n}</h2>\n            </div>\n            ${e.map((n=>`\n                <div class="review-result">\n                    ${n}\n                </div>\n            `)).join("<hr>")}\n        </div>\n    `)).join("")}\n\n    <div class="model-comparison">\n        <h2>模型对比分析</h2>\n        <table class="comparison-table">\n            <thead>\n                <tr>\n                    <th>模型名称</th>\n                    <th>审核文件数</th>\n                    <th>平均响应时间</th>\n                    <th>特点分析</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${Object.entries(t).map((([n,e])=>`\n                    <tr>\n                        <td>${n}</td>\n                        <td>${e.length}</td>\n                        <td>${(e.reduce(((n,e)=>n+e.responseTime),0)/e.length).toFixed(2)}ms</td>\n                        <td>${this.getModelAnalysis(n,e)}</td>\n                    </tr>\n                `)).join("")}\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>`,a=e.join(process.cwd(),"code-review-comparison.html");return n.writeFileSync(a,o),a}getModelAnalysis(n,e){return{"bigscience/bloom-560m":"开源模型，响应较快，适合基础代码审查","qwen-7b-chat":"中文理解能力强，适合中文项目代码审查","gpt-3.5-turbo":"通用性强，代码审查质量较高"}[n]||"暂无分析"}};
//# sourceMappingURL=code-review.js.map
